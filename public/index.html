<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/favicon.png" type="image/png">
  <title>Port Daddy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #1a1a2e;
      --bg-card: #16213e;
      --bg-input: #0f0f1a;
      --accent: #d4a03c;
      --accent-dim: #b8860b;
      --accent-soft: #c9985a;
      --text: #e0ddd8;
      --text-dim: #9a9590;
      --text-muted: #6a6560;
      --success: #6dd194;
      --warning: #e5b655;
      --danger: #e07070;
      --info: #70a5e0;
      --border: #2a2a40;
    }
    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      letter-spacing: 0.01em;
      -webkit-font-smoothing: antialiased;
    }
    .container { max-width: 1800px; margin: 0 auto; padding: 20px; }

    .text-muted { color: var(--text-muted); }

    /* Icons */
    .icon {
      width: 16px; height: 16px; display: inline-block; vertical-align: middle;
      fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
    }
    .icon-lg { width: 20px; height: 20px; }
    .icon-xl { width: 24px; height: 24px; }

    /* Header */
    .header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 0; border-bottom: 1px solid var(--border); margin-bottom: 20px;
    }
    .logo { display: flex; align-items: center; gap: 16px; }
    .logo-mark {
      width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      border-radius: 12px; display: flex; align-items: center; justify-content: center;
    }
    .logo-mark svg { width: 28px; height: 28px; stroke: var(--bg-dark); stroke-width: 2.5; }
    .logo-text h1 {
      font-size: 1.8em; font-weight: 700; letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--accent) 0%, #f0d890 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .logo-text .tagline { color: var(--text-dim); font-size: 0.85em; font-weight: 400; }
    .header-right { display: flex; gap: 16px; align-items: center; }
    .status-pill {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 14px; border-radius: 20px; font-size: 0.8em;
      background: var(--bg-card); border: 1px solid var(--border);
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }
    .status-dot.offline { background: var(--danger); }
    .version-info { text-align: right; font-size: 0.75em; color: var(--text-muted); }
    .version-info code { color: var(--accent); }
    .settings-btn {
      background: none; border: 1px solid var(--border); color: var(--text-dim);
      width: 36px; height: 36px; border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .settings-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* Command Bar */
    .command-bar {
      background: var(--bg-dark); border: 1px solid var(--border);
      border-radius: 6px; padding: 4px; margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
    }
    .command-bar .prompt { color: var(--accent); padding: 0 12px; font-weight: 600; }
    .command-bar input {
      flex: 1; background: none; border: none; color: var(--text);
      font-family: inherit; font-size: 0.95em; padding: 12px 0; outline: none;
    }
    .command-bar input::placeholder { color: var(--text-muted); }
    .command-bar button {
      background: var(--accent); color: var(--bg-dark); border: none;
      padding: 10px 20px; border-radius: 6px; font-family: inherit;
      font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .command-bar button:hover { background: #e8b84a; }
    .command-output {
      font-size: 0.9em; min-height: 350px; overflow-y: auto;
    }
    .command-output pre { white-space: pre-wrap; word-break: break-all; margin: 0; }
    .command-output .success { color: var(--success); }
    .command-output .error { color: var(--danger); }

    /* Quick Actions */
    .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .quick-btn {
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text); padding: 8px 16px; border-radius: 6px;
      font-family: inherit; font-size: 0.8em; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .quick-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* Stats Grid */
    .stats {
      display: flex; gap: 12px; margin-bottom: 20px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px 16px;
    }
    .stat {
      display: flex; align-items: center; gap: 10px;
      padding-right: 16px; border-right: 1px solid var(--border);
    }
    .stat:last-child { border-right: none; padding-right: 0; }
    .stat .value { font-size: 1.4em; font-weight: 700; color: var(--accent); }
    .stat .label {
      font-size: 0.7em; color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px;
    }
    @media (max-width: 900px) {
      .stats { flex-wrap: wrap; }
      .stat { border-right: none; padding-right: 0; }
    }

    /* Tabs */
    .tabs-container {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 8px; overflow: hidden;
      max-height: calc(100vh - 180px); display: flex; flex-direction: column;
    }
    .tabs {
      display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border);
      padding: 8px 8px 0;
    }
    .tab {
      padding: 8px 12px; background: none; border: none;
      color: var(--text-dim); font-family: inherit; font-size: 0.75em;
      cursor: pointer; border-bottom: 2px solid transparent;
      transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 6px;
      margin-bottom: -1px;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--bg-input); border-radius: 4px 4px 0 0; }
    .tab-content { display: none; padding: 16px; overflow-y: auto; flex: 1; }
    .tab-content.active { display: block; }

    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left; padding: 12px 16px; font-size: 0.75em;
      color: var(--accent); text-transform: uppercase; letter-spacing: 1px;
      border-bottom: 1px solid var(--border);
    }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 0.9em; }
    tr:hover { background: rgba(255,255,255,0.02); }
    .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }

    /* Badges */
    .badge {
      display: inline-block; padding: 3px 10px; border-radius: 4px;
      font-size: 0.75em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .badge-success { background: rgba(74, 222, 128, 0.15); color: var(--success); }
    .badge-warning { background: rgba(251, 191, 36, 0.15); color: var(--warning); }
    .badge-danger { background: rgba(248, 113, 113, 0.15); color: var(--danger); }
    .badge-info { background: rgba(96, 165, 250, 0.15); color: var(--info); }
    .badge-muted { background: rgba(255,255,255,0.05); color: var(--text-muted); }

    code {
      background: var(--bg-input); padding: 2px 8px; border-radius: 4px;
      font-size: 0.9em; color: var(--accent);
    }

    /* Action Buttons */
    .action-btn {
      background: none; border: 1px solid var(--border); color: var(--text-dim);
      padding: 4px 10px; border-radius: 4px; font-family: inherit;
      font-size: 0.75em; cursor: pointer; transition: all 0.2s;
    }
    .action-btn:hover { border-color: var(--accent); color: var(--accent); }
    .action-btn.danger:hover { border-color: var(--danger); color: var(--danger); }

    /* Activity Feed */
    .activity-feed { max-height: 500px; overflow-y: auto; }
    .activity-item {
      display: flex; gap: 12px; padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon {
      width: 36px; height: 36px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; background: rgba(255,255,255,0.05); color: var(--text-dim);
    }
    .activity-content { flex: 1; }
    .activity-content .type { font-weight: 500; color: var(--text); font-size: 0.9em; }
    .activity-content .details { font-size: 0.8em; color: var(--text-dim); margin-top: 2px; }
    .activity-content .time { font-size: 0.7em; color: var(--text-muted); margin-top: 4px; }

    /* Channels */
    .channel-card {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 6px; padding: 14px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .channel-name { font-weight: 500; color: var(--accent); }
    .channel-stats { font-size: 0.8em; color: var(--text-muted); }

    /* Settings Panel */
    .settings-panel {
      position: fixed; top: 0; right: -400px; width: 400px; height: 100vh;
      background: var(--bg-card); border-left: 1px solid var(--border);
      z-index: 1000; transition: right 0.3s ease; overflow-y: auto;
    }
    .settings-panel.open { right: 0; }
    .settings-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 999; display: none;
    }
    .settings-overlay.open { display: block; }
    .settings-header {
      padding: 20px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .settings-header h2 { font-size: 1.2em; color: var(--accent); }
    .settings-close {
      background: none; border: none; color: var(--text-dim);
      cursor: pointer; padding: 8px;
    }
    .settings-close:hover { color: var(--text); }
    .settings-section { padding: 20px; border-bottom: 1px solid var(--border); }
    .settings-section h3 { font-size: 0.85em; color: var(--text); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .settings-section p { font-size: 0.8em; color: var(--text-muted); margin-bottom: 12px; }
    .setting-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid var(--border);
    }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { font-size: 0.85em; }
    .setting-desc { font-size: 0.75em; color: var(--text-muted); margin-top: 2px; }
    .toggle {
      width: 44px; height: 24px; background: var(--border); border-radius: 12px;
      position: relative; cursor: pointer; transition: background 0.2s;
    }
    .toggle.on { background: var(--accent); }
    .toggle::after {
      content: ''; position: absolute; top: 2px; left: 2px;
      width: 20px; height: 20px; background: white; border-radius: 50%;
      transition: left 0.2s;
    }
    .toggle.on::after { left: 22px; }
    .rule-list { margin-top: 12px; }
    .rule-item {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 6px; padding: 10px 12px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.85em;
    }
    .rule-item code { font-size: 0.9em; }
    .rule-item .remove-rule {
      background: none; border: none; color: var(--danger);
      cursor: pointer; padding: 4px;
    }
    .add-rule-form { display: flex; gap: 8px; margin-top: 12px; }
    .add-rule-form input {
      flex: 1; background: var(--bg-input); border: 1px solid var(--border);
      color: var(--text); padding: 8px 12px; border-radius: 6px;
      font-family: inherit; font-size: 0.85em;
    }
    .add-rule-form button {
      background: var(--accent); color: var(--bg-dark); border: none;
      padding: 8px 16px; border-radius: 6px; font-family: inherit;
      font-weight: 600; cursor: pointer;
    }

    /* Footer */
    .footer {
      text-align: center; padding: 20px; color: var(--text-muted);
      font-size: 0.75em; border-top: 1px solid var(--border); margin-top: 20px;
    }
    .footer a { color: var(--accent); text-decoration: none; }

    .refresh-btn {
      background: none; border: 1px solid var(--border); color: var(--text-dim);
      padding: 6px 12px; border-radius: 4px; font-family: inherit;
      font-size: 0.8em; cursor: pointer; transition: all 0.2s; margin-bottom: 12px;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }
    .filter-select {
      background: var(--bg-input); border: 1px solid var(--border);
      color: var(--text); padding: 6px 12px; border-radius: 4px;
      font-family: inherit; font-size: 0.8em; margin-left: 8px;
    }

    /* Config Tab */
    .config-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    @media (max-width: 900px) { .config-grid { grid-template-columns: 1fr; } }
    .config-item {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 8px; padding: 16px;
    }
    .config-label {
      font-size: 0.85em; font-weight: 600; color: var(--text);
      display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
    }
    .config-path {
      display: block; background: var(--bg-dark); padding: 10px 14px;
      border-radius: 4px; font-size: 0.85em; color: var(--accent);
      word-break: break-all; margin-bottom: 8px;
    }
    .config-desc { font-size: 0.75em; color: var(--text-muted); line-height: 1.4; }

    /* Command buttons (used in modals) */
    .cmd-btn {
      background: none; border: 1px solid var(--border); color: var(--text-dim);
      width: 32px; height: 32px; border-radius: 4px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .cmd-btn:hover { border-color: var(--accent); color: var(--accent); }
    .cmd-btn.copied, .cmd-btn.ran { border-color: var(--success); color: var(--success); }

    /* Danger button */
    .danger-btn { border-color: var(--danger) !important; color: var(--danger) !important; }
    .danger-btn:hover { background: rgba(248, 113, 113, 0.1) !important; }

    /* Accent button */
    .accent-btn { border-color: var(--accent) !important; color: var(--accent) !important; }
    .accent-btn:hover { background: rgba(212, 160, 60, 0.15) !important; }

    /* Tutorial mode styling in terminal */
    .tutorial-output { color: var(--text); line-height: 1.6; }
    .tutorial-output h4 {
      color: var(--accent); margin: 20px 0 8px 0; font-size: 1.1em;
      border-bottom: 1px solid var(--border); padding-bottom: 4px;
    }
    .tutorial-output h4:first-child { margin-top: 0; }
    .tutorial-output .cmd {
      background: var(--bg-card); padding: 8px 12px; border-radius: 4px;
      margin: 6px 0; font-size: 0.95em; color: #f0d890;
      border-left: 3px solid var(--accent);
      font-family: inherit;
    }
    .tutorial-output .desc { color: var(--text); font-size: 0.9em; margin-bottom: 12px; }
    .tutorial-output .note { color: var(--text-dim); font-size: 0.85em; font-style: italic; margin-top: 4px; }

    /* Modal integration cards */
    .integrate-grid { display: grid; grid-template-columns: 1fr; gap: 12px; max-height: 400px; overflow-y: auto; }
    .integrate-card {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 6px; padding: 12px;
    }
    .integrate-card:hover { border-color: var(--border); }
    .integrate-name { color: var(--text); font-weight: 500; font-size: 0.9em; margin-bottom: 4px; }
    .integrate-desc { color: var(--text-muted); font-size: 0.75em; margin-bottom: 8px; line-height: 1.4; }
    .integrate-cmd {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg-dark); padding: 8px 10px; border-radius: 4px;
    }
    .integrate-cmd code { flex: 1; font-size: 0.8em; color: var(--accent-soft); word-break: break-all; }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 2000; display: none;
      align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 12px; padding: 24px; max-width: 600px; width: 90%;
      max-height: 85vh; overflow-y: auto;
    }
    .modal h3 { color: var(--accent); margin-bottom: 16px; }
    .modal p { color: var(--text-dim); font-size: 0.9em; margin-bottom: 16px; line-height: 1.5; }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
    .modal-btn {
      padding: 10px 20px; border-radius: 6px; font-family: inherit;
      font-weight: 600; cursor: pointer; border: 1px solid var(--border);
      background: var(--bg-input); color: var(--text); transition: all 0.2s;
    }
    .modal-btn:hover { border-color: var(--accent); }
    .modal-btn.danger { background: var(--danger); color: white; border-color: var(--danger); }
    .modal-btn.danger:hover { background: #e05555; }

    /* Shortcuts display */
    .shortcut-list { display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; }
    .shortcut-key {
      background: var(--bg-input); border: 1px solid var(--border);
      padding: 4px 10px; border-radius: 4px; font-size: 0.85em;
      color: var(--accent); font-family: inherit; text-align: center;
    }
    .shortcut-desc { color: var(--text-dim); font-size: 0.9em; display: flex; align-items: center; }

  </style>
</head>
<body>
  <!-- SVG Icons -->
  <svg style="display:none">
    <symbol id="icon-server" viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></symbol>
    <symbol id="icon-bot" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></symbol>
    <symbol id="icon-lock" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></symbol>
    <symbol id="icon-unlock" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></symbol>
    <symbol id="icon-message" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></symbol>
    <symbol id="icon-webhook" viewBox="0 0 24 24"><path d="M18 16.98h-5.99c-1.1 0-1.95.68-2.95 1.76"/><path d="M18 21h-6c-2.21 0-4-1.79-4-4v-2"/><path d="M6 7.02h5.99c1.1 0 1.95-.68 2.95-1.76"/><path d="M6 3h6c2.21 0 4 1.79 4 4v2"/></symbol>
    <symbol id="icon-activity" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></symbol>
    <symbol id="icon-x" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
    <symbol id="icon-refresh" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></symbol>
    <symbol id="icon-clock" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></symbol>
    <symbol id="icon-play" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></symbol>
    <symbol id="icon-box" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></symbol>
    <symbol id="icon-send" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></symbol>
    <symbol id="icon-zap" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></symbol>
    <symbol id="icon-heart" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
    <symbol id="icon-folder" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></symbol>
    <symbol id="icon-book" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></symbol>
    <symbol id="icon-terminal" viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></symbol>
    <symbol id="icon-run" viewBox="0 0 24 24"><rect x="2" y="4" width="16" height="14" rx="2"/><polyline points="5 14 8 11 5 8"/><line x1="10" y1="14" x2="14" y2="14"/><path d="M18 10l4 2-4 2"/></symbol>
    <symbol id="icon-copy" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
    <symbol id="icon-code" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></symbol>
  </svg>

  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="logo-mark">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </div>
        <div class="logo-text">
          <h1>Port Daddy</h1>
          <div class="tagline">The Authority on Ports</div>
        </div>
      </div>
      <div class="header-right">
        <div class="status-pill">
          <div class="status-dot online" id="status-dot"></div>
          <span id="status-text">Online</span>
        </div>
        <div class="version-info">
          <div>v<code id="version">-</code></div>
          <div>PID <code id="pid">-</code></div>
        </div>
        <button class="settings-btn" onclick="openSettings()">
          <svg class="icon-lg"><use href="#icon-settings"/></svg>
        </button>
      </div>
    </div>

    <!-- Stats bar at top -->
    <div class="stats">
      <div class="stat"><div class="value" id="stat-services">-</div><div class="label"><svg class="icon"><use href="#icon-server"/></svg>Services</div></div>
      <div class="stat"><div class="value" id="stat-agents">-</div><div class="label"><svg class="icon"><use href="#icon-bot"/></svg>Agents</div></div>
      <div class="stat"><div class="value" id="stat-locks">-</div><div class="label"><svg class="icon"><use href="#icon-lock"/></svg>Locks</div></div>
      <div class="stat"><div class="value" id="stat-channels">-</div><div class="label"><svg class="icon"><use href="#icon-message"/></svg>Channels</div></div>
      <div class="stat"><div class="value" id="stat-webhooks">-</div><div class="label"><svg class="icon"><use href="#icon-webhook"/></svg>Webhooks</div></div>
      <div class="stat"><div class="value" id="stat-uptime">-</div><div class="label"><svg class="icon"><use href="#icon-clock"/></svg>Uptime</div></div>
    </div>

    <!-- Quick actions -->
    <div class="quick-actions">
      <button class="quick-btn accent-btn" onclick="showIntegrateModal()"><svg class="icon"><use href="#icon-code"/></svg>Integrate Into Your Stack</button>
      <button class="quick-btn danger-btn" onclick="releaseAllServices()" title="Remove all services from Port Daddy's database (does NOT kill processes)"><svg class="icon"><use href="#icon-trash"/></svg>Release All</button>
      <button class="quick-btn" onclick="showShortcuts()"><svg class="icon"><use href="#icon-zap"/></svg>Shortcuts</button>
    </div>

    <!-- All panels including terminal -->
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab active" data-tab="terminal"><svg class="icon"><use href="#icon-terminal"/></svg>Terminal</button>
        <button class="tab" data-tab="services"><svg class="icon"><use href="#icon-server"/></svg>Services</button>
        <button class="tab" data-tab="agents"><svg class="icon"><use href="#icon-bot"/></svg>Agents</button>
        <button class="tab" data-tab="locks"><svg class="icon"><use href="#icon-lock"/></svg>Locks</button>
        <button class="tab" data-tab="channels"><svg class="icon"><use href="#icon-message"/></svg>Channels</button>
        <button class="tab" data-tab="webhooks"><svg class="icon"><use href="#icon-webhook"/></svg>Webhooks</button>
        <button class="tab" data-tab="activity"><svg class="icon"><use href="#icon-activity"/></svg>Activity</button>
        <button class="tab" data-tab="config"><svg class="icon"><use href="#icon-folder"/></svg>Config</button>
      </div>

      <div class="tab-content active" id="tab-terminal">
        <!-- Command bar inside terminal tab -->
        <div class="command-bar">
          <span class="prompt">$</span>
          <input type="text" id="command-input" placeholder="Type a command or 'help' for list" autofocus list="cmd-suggestions">
          <datalist id="cmd-suggestions">
            <option value="claim myapp:api">
            <option value="release myapp:api">
            <option value="find">
            <option value="find 'myapp:*'">
            <option value="lock db-migrations">
            <option value="unlock db-migrations">
            <option value="locks">
            <option value="agents">
            <option value="status">
            <option value="log --limit 20">
            <option value="help">
            <option value="tutorial">
          </datalist>
          <button onclick="runCommand()">Run</button>
        </div>
        <div class="command-output" id="command-output">
          <pre id="command-result"><span class="text-muted">Type a command above, or try: find, locks, agents, status, tutorial</span></pre>
        </div>
      </div>

      <div class="tab-content" id="tab-services">
        <button class="refresh-btn" onclick="refreshServices()"><svg class="icon"><use href="#icon-refresh"/></svg>Refresh</button>
        <table>
          <thead><tr><th>Identity</th><th>Port</th><th>Status</th><th>PID</th><th>URL</th><th>Age</th><th></th></tr></thead>
          <tbody id="services-body"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody>
        </table>
      </div>

      <div class="tab-content" id="tab-agents">
        <button class="refresh-btn" onclick="refreshAgents()"><svg class="icon"><use href="#icon-refresh"/></svg>Refresh</button>
        <table>
          <thead><tr><th>Agent ID</th><th>Type</th><th>PID</th><th>Status</th><th>Last Heartbeat</th><th>Limits</th><th></th></tr></thead>
          <tbody id="agents-body"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody>
        </table>
      </div>

      <div class="tab-content" id="tab-locks">
        <button class="refresh-btn" onclick="refreshLocks()"><svg class="icon"><use href="#icon-refresh"/></svg>Refresh</button>
        <table>
          <thead><tr><th>Lock Name</th><th>Owner</th><th>PID</th><th>Acquired</th><th>Expires</th><th></th></tr></thead>
          <tbody id="locks-body"><tr><td colspan="6" class="empty-state">Loading...</td></tr></tbody>
        </table>
      </div>

      <div class="tab-content" id="tab-channels">
        <button class="refresh-btn" onclick="refreshChannels()"><svg class="icon"><use href="#icon-refresh"/></svg>Refresh</button>
        <div id="channels-list"><div class="empty-state">Loading...</div></div>
      </div>

      <div class="tab-content" id="tab-webhooks">
        <button class="refresh-btn" onclick="refreshWebhooks()"><svg class="icon"><use href="#icon-refresh"/></svg>Refresh</button>
        <table>
          <thead><tr><th>Endpoint</th><th>Events</th><th>Status</th><th>Deliveries</th><th>Last Triggered</th></tr></thead>
          <tbody id="webhooks-body"><tr><td colspan="5" class="empty-state">Loading...</td></tr></tbody>
        </table>
      </div>

      <div class="tab-content" id="tab-activity">
        <button class="refresh-btn" onclick="refreshActivity()"><svg class="icon"><use href="#icon-refresh"/></svg>Refresh</button>
        <select class="filter-select" id="activity-filter" onchange="refreshActivity()">
          <option value="">All Activity</option>
          <option value="service.claim">Claims</option>
          <option value="service.release">Releases</option>
          <option value="lock.acquire">Lock Acquires</option>
          <option value="lock.release">Lock Releases</option>
          <option value="agent.register">Agent Registers</option>
        </select>
        <div class="activity-feed" id="activity-feed"><div class="empty-state">Loading...</div></div>
      </div>

      <div class="tab-content" id="tab-config">
        <h3 style="color:var(--accent);margin-bottom:16px">Configuration Locations</h3>
        <div class="config-grid" id="config-grid">
          <div class="config-item">
            <div class="config-label"><svg class="icon"><use href="#icon-folder"/></svg>Database</div>
            <code class="config-path" id="config-db">Loading...</code>
            <div class="config-desc">SQLite database storing all services, locks, agents, and messages</div>
          </div>
          <div class="config-item">
            <div class="config-label"><svg class="icon"><use href="#icon-folder"/></svg>Daemon PID</div>
            <code class="config-path" id="config-pid">Loading...</code>
            <div class="config-desc">Process ID file for the running daemon</div>
          </div>
          <div class="config-item">
            <div class="config-label"><svg class="icon"><use href="#icon-folder"/></svg>Logs</div>
            <code class="config-path" id="config-log">Loading...</code>
            <div class="config-desc">Daemon log output (when running as service)</div>
          </div>
          <div class="config-item">
            <div class="config-label"><svg class="icon"><use href="#icon-folder"/></svg>Installation</div>
            <code class="config-path" id="config-install">Loading...</code>
            <div class="config-desc">Port Daddy installation directory</div>
          </div>
          <div class="config-item">
            <div class="config-label"><svg class="icon"><use href="#icon-folder"/></svg>CLI Skill</div>
            <code class="config-path">~/.claude/commands/port-daddy.md</code>
            <div class="config-desc">Agentic skill file teaching Claude how to use Port Daddy</div>
          </div>
          <div class="config-item">
            <div class="config-label"><svg class="icon"><use href="#icon-settings"/></svg>Environment</div>
            <code class="config-path">PORT_DADDY_PORT, PORT_DADDY_RANGE_START, PORT_DADDY_RANGE_END</code>
            <div class="config-desc">Optional env vars to customize port and range</div>
          </div>
        </div>
      </div>

    </div>
    </div>

    <div class="footer">
      Auto-refreshes every 5s · <a href="https://github.com/erichowens/port-daddy">GitHub</a> · Port Daddy — Because port conflicts are beneath you.
    </div>
  </div>

  <!-- Modals -->
  <div class="modal-overlay" id="modal-overlay" onclick="closeModal()">
    <div class="modal" id="modal-content" onclick="event.stopPropagation()"></div>
  </div>

  <!-- Settings Panel -->
  <div class="settings-overlay" id="settings-overlay" onclick="closeSettings()"></div>
  <div class="settings-panel" id="settings-panel">
    <div class="settings-header">
      <h2>Settings</h2>
      <button class="settings-close" onclick="closeSettings()"><svg class="icon-lg"><use href="#icon-x"/></svg></button>
    </div>

    <div class="settings-section">
      <h3>Auto-Launch Dashboard</h3>
      <p>Open dashboard automatically when Port Daddy is used</p>
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable auto-launch</div>
          <div class="setting-desc">Opens dashboard on first command in session</div>
        </div>
        <div class="toggle" id="toggle-autolaunch" onclick="toggleSetting('autolaunch')"></div>
      </div>
    </div>

    <div class="settings-section">
      <h3>Project Rules</h3>
      <p>Auto-launch only for specific projects (empty = all projects)</p>
      <div class="rule-list" id="project-rules"></div>
      <div class="add-rule-form">
        <input type="text" id="new-project-rule" placeholder="myapp:*">
        <button onclick="addProjectRule()">Add</button>
      </div>
    </div>

    <div class="settings-section">
      <h3>Command Rules</h3>
      <p>Auto-launch only for specific commands (empty = all commands)</p>
      <div class="rule-list" id="command-rules"></div>
      <div class="add-rule-form">
        <input type="text" id="new-command-rule" placeholder="claim">
        <button onclick="addCommandRule()">Add</button>
      </div>
    </div>

    <div class="settings-section">
      <h3>Behavior</h3>
      <div class="setting-row">
        <div>
          <div class="setting-label">Stay in background</div>
          <div class="setting-desc">Don't steal focus when auto-launching</div>
        </div>
        <div class="toggle" id="toggle-background" onclick="toggleSetting('background')"></div>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Once per session</div>
          <div class="setting-desc">Only auto-launch once per terminal session</div>
        </div>
        <div class="toggle on" id="toggle-once" onclick="toggleSetting('once')"></div>
      </div>
    </div>
  </div>

  <script>
    const API = '';

    // Settings storage
    let settings = JSON.parse(localStorage.getItem('portdaddy-settings') || '{}');
    settings = {
      autolaunch: settings.autolaunch ?? false,
      background: settings.background ?? false,
      once: settings.once ?? true,
      projectRules: settings.projectRules || [],
      commandRules: settings.commandRules || []
    };

    function saveSettings() {
      localStorage.setItem('portdaddy-settings', JSON.stringify(settings));
    }

    function openSettings() {
      document.getElementById('settings-panel').classList.add('open');
      document.getElementById('settings-overlay').classList.add('open');
      renderSettings();
    }

    function closeSettings() {
      document.getElementById('settings-panel').classList.remove('open');
      document.getElementById('settings-overlay').classList.remove('open');
    }

    function toggleSetting(key) {
      settings[key] = !settings[key];
      saveSettings();
      renderSettings();
    }

    function renderSettings() {
      document.getElementById('toggle-autolaunch').className = 'toggle' + (settings.autolaunch ? ' on' : '');
      document.getElementById('toggle-background').className = 'toggle' + (settings.background ? ' on' : '');
      document.getElementById('toggle-once').className = 'toggle' + (settings.once ? ' on' : '');

      const projectRules = document.getElementById('project-rules');
      projectRules.innerHTML = settings.projectRules.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8em">No rules (launches for all projects)</div>' :
        settings.projectRules.map((r, i) => `<div class="rule-item"><code>${r}</code><button class="remove-rule" onclick="removeProjectRule(${i})"><svg class="icon"><use href="#icon-trash"/></svg></button></div>`).join('');

      const commandRules = document.getElementById('command-rules');
      commandRules.innerHTML = settings.commandRules.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8em">No rules (launches for all commands)</div>' :
        settings.commandRules.map((r, i) => `<div class="rule-item"><code>${r}</code><button class="remove-rule" onclick="removeCommandRule(${i})"><svg class="icon"><use href="#icon-trash"/></svg></button></div>`).join('');
    }

    function addProjectRule() {
      const input = document.getElementById('new-project-rule');
      if (input.value.trim()) {
        settings.projectRules.push(input.value.trim());
        input.value = '';
        saveSettings();
        renderSettings();
      }
    }

    function removeProjectRule(i) {
      settings.projectRules.splice(i, 1);
      saveSettings();
      renderSettings();
    }

    function addCommandRule() {
      const input = document.getElementById('new-command-rule');
      if (input.value.trim()) {
        settings.commandRules.push(input.value.trim());
        input.value = '';
        saveSettings();
        renderSettings();
      }
    }

    function removeCommandRule(i) {
      settings.commandRules.splice(i, 1);
      saveSettings();
      renderSettings();
    }

    // Tab switching
    function switchToTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tabName}"]`)?.classList.add('active');
      document.getElementById('tab-' + tabName)?.classList.add('active');
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchToTab(tab.dataset.tab));
    });

    // Command bar
    document.getElementById('command-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') runCommand();
    });

    async function runCommand() {
      const input = document.getElementById('command-input');
      const output = document.getElementById('command-output');
      const result = document.getElementById('command-result');
      let cmd = input.value.trim();
      if (!cmd) return;
      if (cmd.startsWith('port-daddy ')) cmd = cmd.substring(11);

      // Switch to Terminal tab
      switchToTab('terminal');

      result.innerHTML = '<span style="color:var(--text-muted)">Running...</span>';

      try {
        const data = await executeCommand(cmd);
        // Handle HTML output (for tutorial mode)
        if (data._html) {
          result.innerHTML = data._html;
        } else {
          result.innerHTML = '<span class="success">' + escapeHtml(JSON.stringify(data, null, 2)) + '</span>';
        }
        refreshAll();
      } catch (err) {
        result.innerHTML = '<span class="error">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    function quickCommand(cmd) {
      document.getElementById('command-input').value = cmd;
      runCommand();
    }

    const COMMANDS = {
      claim:    { args: '<id>', opts: ['--port <n>'], desc: 'Claim a port for a service' },
      release:  { args: '<id>', opts: [], desc: 'Release a service' },
      find:     { args: '[pattern]', opts: [], desc: 'List services (alias: ps)' },
      ps:       { args: '[pattern]', opts: [], desc: 'List services' },
      lock:     { args: '<name>', opts: ['--ttl <ms>', '--owner <id>'], desc: 'Acquire a lock' },
      unlock:   { args: '<name>', opts: ['--owner <id>'], desc: 'Release a lock' },
      locks:    { args: '', opts: [], desc: 'List all locks' },
      agents:   { args: '', opts: [], desc: 'List all agents' },
      log:      { args: '', opts: ['--limit <n>'], desc: 'View activity log' },
      activity: { args: '', opts: ['--limit <n>'], desc: 'View activity log' },
      status:   { args: '', opts: [], desc: 'Health check' },
      pub:      { args: '<channel> <json>', opts: [], desc: 'Publish a message' },
      help:     { args: '', opts: [], desc: 'Show available commands' },
      tutorial: { args: '', opts: [], desc: 'Show command tutorial' }
    };

    async function executeCommand(cmd) {
      const parts = cmd.split(/\s+/);
      const verb = parts[0]?.toLowerCase();
      const args = parts.slice(1);
      const opts = {};

      if (!verb) {
        throw new Error('No command entered. Try: claim, find, lock, status, help');
      }

      if (verb === 'help') {
        return {
          commands: Object.entries(COMMANDS).map(([name, info]) => ({
            command: name + (info.args ? ' ' + info.args : ''),
            options: info.opts.join(', ') || 'none',
            description: info.desc
          }))
        };
      }

      if (verb === 'tutorial') {
        return { _html: renderTutorial() };
      }

      if (!COMMANDS[verb]) {
        const similar = Object.keys(COMMANDS).filter(c => c.startsWith(verb[0]) || c.includes(verb));
        throw new Error(`Unknown command: "${verb}"\n\nAvailable: ${Object.keys(COMMANDS).join(', ')}${similar.length ? '\n\nDid you mean: ' + similar.join(', ') + '?' : ''}`);
      }

      for (let i = 0; i < args.length; i++) {
        if (args[i] === '--json' || args[i] === '-j') opts.json = true;
        else if (args[i] === '--port' || args[i] === '-p') opts.port = parseInt(args[++i]);
        else if (args[i] === '--limit') opts.limit = parseInt(args[++i]);
        else if (args[i] === '--owner') opts.owner = args[++i];
        else if (args[i] === '--ttl') opts.ttl = parseInt(args[++i]);
        else if (!args[i].startsWith('-')) opts.target = opts.target || args[i];
      }

      // Validate required arguments
      const needsTarget = ['claim', 'release', 'lock', 'unlock', 'pub'];
      if (needsTarget.includes(verb) && !opts.target) {
        const info = COMMANDS[verb];
        throw new Error(`Missing required argument.\n\nUsage: ${verb} ${info.args}${info.opts.length ? '\nOptions: ' + info.opts.join(', ') : ''}`);
      }

      switch (verb) {
        case 'claim': return fetch(API + '/claim/' + opts.target, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ port: opts.port }) }).then(r => r.json());
        case 'release': return fetch(API + '/release/' + opts.target, { method: 'DELETE' }).then(r => r.json());
        case 'find': case 'ps': return fetch(opts.target ? API + '/services?pattern=' + encodeURIComponent(opts.target) : API + '/services').then(r => r.json());
        case 'lock': return fetch(API + '/locks/' + opts.target, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ owner: opts.owner || 'dashboard', ttl: opts.ttl }) }).then(r => r.json());
        case 'unlock': return fetch(API + '/locks/' + opts.target, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ owner: opts.owner || 'dashboard', force: true }) }).then(r => r.json());
        case 'locks': return fetch(API + '/locks').then(r => r.json());
        case 'agents': return fetch(API + '/agents').then(r => r.json());
        case 'log': case 'activity': return fetch(API + '/activity?limit=' + (opts.limit || 20)).then(r => r.json());
        case 'status': return fetch(API + '/health').then(r => r.json());
        case 'pub': const payload = args.find(a => a.startsWith('{')) || '{}'; return fetch(API + '/msg/' + opts.target, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ payload: JSON.parse(payload) }) }).then(r => r.json());
        default: throw new Error(`Unknown command: ${verb}`);
      }
    }

    function escapeHtml(str) { return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function formatTime(ts) { return new Date(ts).toLocaleTimeString(); }
    function formatAge(ms) { const m = Math.floor(ms / 60000); if (m < 60) return m + 'm'; const h = Math.floor(m / 60); if (h < 24) return h + 'h'; return Math.floor(h / 24) + 'd'; }
    function formatUptime(s) { const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60); return h > 0 ? h + 'h ' + m + 'm' : m + 'm'; }

    async function releaseService(id) { if (!confirm('Release ' + id + '?')) return; await fetch(API + '/release/' + encodeURIComponent(id), { method: 'DELETE' }); refreshServices(); }
    async function releaseLock(name) { if (!confirm('Force release ' + name + '?')) return; await fetch(API + '/locks/' + encodeURIComponent(name), { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ force: true }) }); refreshLocks(); }
    async function unregisterAgent(id) { if (!confirm('Unregister ' + id + '?')) return; await fetch(API + '/agents/' + encodeURIComponent(id), { method: 'DELETE' }); refreshAgents(); }

    function renderTable(tbody, rows, empty, cols) {
      tbody.textContent = '';
      if (rows.length === 0) { const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan = cols; td.className = 'empty-state'; td.textContent = empty; tr.appendChild(td); tbody.appendChild(tr); return; }
      rows.forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = r; tbody.appendChild(tr); });
    }

    async function refreshHealth() {
      try {
        const data = await (await fetch(API + '/health')).json();
        document.getElementById('stat-uptime').textContent = formatUptime(data.uptime_seconds);
        document.getElementById('pid').textContent = data.pid;
        document.getElementById('status-text').textContent = 'Online';
        document.getElementById('status-dot').className = 'status-dot online';
      } catch { document.getElementById('status-text').textContent = 'Offline'; document.getElementById('status-dot').className = 'status-dot offline'; }
    }

    async function refreshVersion() { try { const data = await (await fetch(API + '/version')).json(); document.getElementById('version').textContent = data.version; } catch {} }

    async function refreshServices() {
      try {
        const data = await (await fetch(API + '/services')).json();
        document.getElementById('stat-services').textContent = data.count;
        const rows = data.services.map(s => '<td><strong>' + s.id + '</strong></td><td><code>' + s.port + '</code></td><td><span class="badge badge-' + (s.status === 'running' ? 'success' : 'info') + '">' + s.status + '</span></td><td><code>' + (s.pid || '-') + '</code></td><td>' + (s.urls?.local || '-') + '</td><td>' + formatAge(Date.now() - s.createdAt) + '</td><td><button class="action-btn danger" onclick="releaseService(\'' + s.id + '\')">Release</button></td>');
        renderTable(document.getElementById('services-body'), rows, 'No services claimed', 7);
      } catch (e) { console.error(e); }
    }

    async function refreshAgents() {
      try {
        const data = await (await fetch(API + '/agents')).json();
        document.getElementById('stat-agents').textContent = data.agents.filter(a => a.isActive).length;
        const rows = data.agents.map(a => '<td><strong>' + a.id + '</strong></td><td><span class="badge badge-muted">' + a.type + '</span></td><td><code>' + a.pid + '</code></td><td><span class="badge badge-' + (a.isActive ? 'success' : 'danger') + '">' + (a.isActive ? 'Active' : 'Stale') + '</span></td><td>' + formatTime(a.lastHeartbeat) + '</td><td>' + a.maxServices + ' / ' + a.maxLocks + '</td><td><button class="action-btn danger" onclick="unregisterAgent(\'' + a.id + '\')">Remove</button></td>');
        renderTable(document.getElementById('agents-body'), rows, 'No agents registered', 7);
      } catch (e) { console.error(e); }
    }

    async function refreshLocks() {
      try {
        const data = await (await fetch(API + '/locks')).json();
        document.getElementById('stat-locks').textContent = data.count;
        const rows = data.locks.map(l => '<td><strong>' + l.name + '</strong></td><td>' + l.owner + '</td><td><code>' + (l.pid || '-') + '</code></td><td>' + formatTime(l.acquiredAt) + '</td><td>' + (l.expiresAt ? formatTime(l.expiresAt) : 'Never') + '</td><td><button class="action-btn danger" onclick="releaseLock(\'' + l.name + '\')">Force Release</button></td>');
        renderTable(document.getElementById('locks-body'), rows, 'No active locks', 6);
      } catch (e) { console.error(e); }
    }

    async function refreshChannels() {
      try {
        const data = await (await fetch(API + '/channels')).json();
        document.getElementById('stat-channels').textContent = data.count;
        const el = document.getElementById('channels-list');
        el.textContent = '';
        if (data.count === 0) { el.innerHTML = '<div class="empty-state">No active channels</div>'; return; }
        data.channels.forEach(c => { const d = document.createElement('div'); d.className = 'channel-card'; d.innerHTML = '<div class="channel-name">' + c.channel + '</div><div class="channel-stats">' + c.messageCount + ' msgs</div>'; el.appendChild(d); });
      } catch (e) { console.error(e); }
    }

    async function refreshWebhooks() {
      try {
        const data = await (await fetch(API + '/webhooks')).json();
        document.getElementById('stat-webhooks').textContent = data.count;
        const rows = data.webhooks.map(w => '<td><code>' + (w.url.length > 40 ? w.url.substring(0, 40) + '...' : w.url) + '</code></td><td>' + w.events.slice(0, 2).join(', ') + '</td><td><span class="badge badge-' + (w.active ? 'success' : 'warning') + '">' + (w.active ? 'Active' : 'Paused') + '</span></td><td><span class="badge badge-success">' + w.successCount + '</span> / <span class="badge badge-danger">' + w.failureCount + '</span></td><td>' + (w.lastTriggered ? formatTime(w.lastTriggered) : 'Never') + '</td>');
        renderTable(document.getElementById('webhooks-body'), rows, 'No webhooks', 5);
      } catch (e) { console.error(e); }
    }

    async function refreshActivity() {
      try {
        const f = document.getElementById('activity-filter').value;
        const data = await (await fetch(f ? API + '/activity?type=' + f + '&limit=50' : API + '/activity?limit=50')).json();
        const feed = document.getElementById('activity-feed');
        feed.textContent = '';
        if (data.count === 0) { feed.innerHTML = '<div class="empty-state">No activity</div>'; return; }
        const icons = { 'service.claim': '#icon-box', 'service.release': '#icon-send', 'lock.acquire': '#icon-lock', 'lock.release': '#icon-unlock', 'agent.register': '#icon-bot', 'agent.heartbeat': '#icon-heart', 'daemon.start': '#icon-zap' };
        data.entries.forEach(e => { const d = document.createElement('div'); d.className = 'activity-item'; d.innerHTML = '<div class="activity-icon"><svg class="icon"><use href="' + (icons[e.type] || '#icon-activity') + '"/></svg></div><div class="activity-content"><div class="type">' + e.type + '</div><div class="details">' + (e.details || '-') + '</div><div class="time">' + formatTime(e.timestamp) + '</div></div>'; feed.appendChild(d); });
      } catch (e) { console.error(e); }
    }

    async function refreshConfig() {
      try {
        const data = await (await fetch(API + '/version')).json();
        const installDir = data.installDir || '~/.claude/port-daddy';
        document.getElementById('config-db').textContent = installDir + '/port-daddy.db';
        document.getElementById('config-pid').textContent = installDir + '/port-daddy.pid';
        document.getElementById('config-log').textContent = installDir + '/port-daddy.log';
        document.getElementById('config-install').textContent = installDir;
      } catch (e) {
        document.getElementById('config-db').textContent = '~/.claude/port-daddy/port-daddy.db';
        document.getElementById('config-pid').textContent = '~/.claude/port-daddy/port-daddy.pid';
        document.getElementById('config-log').textContent = '~/.claude/port-daddy/port-daddy.log';
        document.getElementById('config-install').textContent = '~/.claude/port-daddy';
      }
    }

    function copyCmd(cmd) {
      navigator.clipboard.writeText(cmd).then(() => {
        const btn = event.currentTarget;
        btn.classList.add('copied');
        setTimeout(() => btn.classList.remove('copied'), 1500);
      });
    }

    function runTutorialCmd(cmd) {
      // Put command in input and run it
      document.getElementById('command-input').value = cmd;
      const btn = event.currentTarget;
      btn.classList.add('ran');
      setTimeout(() => btn.classList.remove('ran'), 1500);
      runCommand();

      // Scroll terminal into view
      document.getElementById('command-output').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // ==========================================================================
    // MODALS
    // ==========================================================================

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('open');
    }

    function showModal(html) {
      document.getElementById('modal-content').innerHTML = html;
      document.getElementById('modal-overlay').classList.add('open');
    }

    function showShortcuts() {
      showModal(`
        <h3>Keyboard Shortcuts</h3>
        <div class="shortcut-list">
          <div class="shortcut-key">Ctrl/⌘ + K</div>
          <div class="shortcut-desc">Focus command bar</div>
          <div class="shortcut-key">Enter</div>
          <div class="shortcut-desc">Run command</div>
          <div class="shortcut-key">↑ / ↓</div>
          <div class="shortcut-desc">Command history</div>
          <div class="shortcut-key">Escape</div>
          <div class="shortcut-desc">Clear output / Close modal</div>
          <div class="shortcut-key">Ctrl/⌘ + /</div>
          <div class="shortcut-desc">Show this help</div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeModal()">Got it</button>
        </div>
      `);
    }

    function renderTutorial() {
      return `<div class="tutorial-output">
        <h4>Claiming Ports</h4>
        <p class="desc">Get a port for your service. Port Daddy assigns and tracks it atomically.</p>
        <div class="cmd">claim myapp:frontend</div>
        <div class="cmd">claim myapp:api --port 3100</div>

        <h4>Finding & Releasing</h4>
        <p class="desc">List services, find by pattern, and release when done.</p>
        <div class="cmd">find</div>
        <div class="cmd">find 'myapp:*'</div>
        <div class="cmd">release myapp:frontend</div>

        <h4>Distributed Locks</h4>
        <p class="desc">Prevent conflicts between agents. Only one holder at a time.</p>
        <div class="cmd">lock db-migrations</div>
        <div class="cmd">lock deploy --ttl 300000</div>
        <div class="cmd">unlock db-migrations</div>
        <div class="cmd">locks</div>

        <h4>Pub/Sub Messaging</h4>
        <p class="desc">Agents can broadcast and listen for events.</p>
        <div class="cmd">pub build:api '{"status":"done"}'</div>
        <p class="note">CLI: port-daddy sub build:* (streaming, not available in dashboard)</p>

        <h4>Agent Registry</h4>
        <p class="desc">Register agents for resource limits and heartbeat monitoring.</p>
        <div class="cmd">agents</div>
        <p class="note">CLI: port-daddy agent register --agent my-agent --type claude</p>

        <h4>Status & Logs</h4>
        <p class="desc">Check health and view activity.</p>
        <div class="cmd">status</div>
        <div class="cmd">log --limit 20</div>

        <p class="note" style="margin-top:16px">Click any command above, then paste in the command bar to run it.</p>
      </div>`;
    }

    function showIntegrateModal() {
      const frameworks = [
        {
          name: 'Next.js / React',
          desc: 'Claims a port, sets PORT env var, starts Next.js dev server on that port.',
          cmd: 'PORT=$(port-daddy claim myapp:frontend -q) && npm run dev -- --port $PORT'
        },
        {
          name: 'Vite',
          desc: 'Claims a port and starts the Vite dev server. Works with Vue, React, Svelte.',
          cmd: 'PORT=$(port-daddy claim myapp:frontend -q) && vite --port $PORT'
        },
        {
          name: 'Express / Node.js',
          desc: 'Claims a port for your API. Your server.js should read process.env.PORT.',
          cmd: 'PORT=$(port-daddy claim myapp:api -q) && node server.js'
        },
        {
          name: 'Python / FastAPI',
          desc: 'Claims a port and starts uvicorn with your FastAPI app.',
          cmd: 'PORT=$(port-daddy claim myapp:api -q) && uvicorn main:app --port $PORT'
        },
        {
          name: 'Flask',
          desc: 'Claims a port and starts the Flask development server.',
          cmd: 'PORT=$(port-daddy claim myapp:api -q) && flask run --port $PORT'
        },
        {
          name: 'Go',
          desc: 'Claims a port and runs your Go app. Read os.Getenv("PORT") in your code.',
          cmd: 'PORT=$(port-daddy claim myapp:api -q) && go run main.go'
        },
        {
          name: 'Ruby / Rails',
          desc: 'Claims a port and starts the Rails server with Puma.',
          cmd: 'PORT=$(port-daddy claim myapp:api -q) && rails server -p $PORT'
        },
        {
          name: 'Docker Compose',
          desc: 'Writes the port to .env file, then starts docker-compose. Your docker-compose.yml should use ${PORT}.',
          cmd: 'echo "PORT=$(port-daddy claim myapp -q)" > .env && docker-compose up'
        },
        {
          name: 'package.json script',
          desc: 'Add this to your package.json scripts for automatic port assignment on npm run dev.',
          cmd: '"dev": "PORT=$(port-daddy claim myapp -q) next dev --port $PORT"'
        }
      ];

      const cards = frameworks.map(f => `
        <div class="integrate-card">
          <div class="integrate-name">${f.name}</div>
          <div class="integrate-desc">${f.desc}</div>
          <div class="integrate-cmd">
            <code>${escapeHtml(f.cmd)}</code>
            <button class="cmd-btn" onclick="copyCmd('${f.cmd.replace(/'/g, "\\'")}')"><svg class="icon"><use href="#icon-copy"/></svg></button>
          </div>
        </div>
      `).join('');

      showModal(`
        <h3 style="margin-bottom:4px">Integrate Into Your Stack</h3>
        <p style="color:var(--text-muted);font-size:0.8em;margin-bottom:16px">
          Copy-paste snippets for your framework. Replace <code>myapp</code> with your project name.
        </p>
        <div class="integrate-grid">
          ${cards}
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeModal()">Close</button>
        </div>
      `);
    }

    async function releaseAllServices() {
      // First get count
      const data = await (await fetch(API + '/services')).json();
      if (data.count === 0) {
        showModal(`
          <h3>No Services</h3>
          <p>There are no services to release.</p>
          <div class="modal-actions">
            <button class="modal-btn" onclick="closeModal()">OK</button>
          </div>
        `);
        return;
      }

      showModal(`
        <h3>Release All Services?</h3>
        <p><strong>This will remove ${data.count} service(s) from Port Daddy's database.</strong></p>
        <p style="color:var(--warning)">
          ⚠️ This does <strong>NOT</strong> kill any running processes.<br>
          Your servers will keep running, but Port Daddy will stop tracking them.
        </p>
        <p>Services to release:</p>
        <ul style="color:var(--text-muted);font-size:0.85em;margin:8px 0 0 20px">
          ${data.services.slice(0, 5).map(s => `<li><code>${s.id}</code> → port ${s.port}</li>`).join('')}
          ${data.count > 5 ? `<li>...and ${data.count - 5} more</li>` : ''}
        </ul>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeModal()">Cancel</button>
          <button class="modal-btn danger" onclick="confirmReleaseAll()">Release All ${data.count} Services</button>
        </div>
      `);
    }

    async function confirmReleaseAll() {
      closeModal();
      const result = document.getElementById('command-result');
      switchToTab('terminal');
      result.innerHTML = '<span style="color:var(--text-muted)">Releasing all services...</span>';

      try {
        const data = await (await fetch(API + '/services')).json();
        let released = 0;
        for (const service of data.services) {
          await fetch(API + '/release/' + encodeURIComponent(service.id), { method: 'DELETE' });
          released++;
        }
        result.innerHTML = `<span class="success">Released ${released} service(s) from Port Daddy database.\n\nNote: Any running processes are still running.\nUse 'lsof -i :PORT' or 'kill PID' to stop them.</span>`;
        refreshAll();
      } catch (err) {
        result.innerHTML = '<span class="error">Error: ' + escapeHtml(err.message) + '</span>';
      }
    }

    // ==========================================================================
    // COMMAND HISTORY
    // ==========================================================================

    let commandHistory = JSON.parse(localStorage.getItem('portdaddy-history') || '[]');
    let historyIndex = -1;

    function saveToHistory(cmd) {
      if (!cmd || cmd === commandHistory[0]) return;
      commandHistory.unshift(cmd);
      if (commandHistory.length > 50) commandHistory.pop();
      localStorage.setItem('portdaddy-history', JSON.stringify(commandHistory));
    }

    // ==========================================================================
    // KEYBOARD SHORTCUTS
    // ==========================================================================

    document.addEventListener('keydown', (e) => {
      const input = document.getElementById('command-input');
      const isInputFocused = document.activeElement === input;

      // Ctrl/Cmd + K: Focus command bar
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        input.focus();
        input.select();
        return;
      }

      // Ctrl/Cmd + /: Show shortcuts
      if ((e.ctrlKey || e.metaKey) && e.key === '/') {
        e.preventDefault();
        showShortcuts();
        return;
      }

      // Escape: Close modal or clear output
      if (e.key === 'Escape') {
        if (document.getElementById('modal-overlay').classList.contains('open')) {
          closeModal();
        } else if (document.getElementById('settings-panel').classList.contains('open')) {
          closeSettings();
        } else {
          input.blur();
        }
        return;
      }

      // When input is focused
      if (isInputFocused) {
        // Up arrow: Previous command
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
            input.value = commandHistory[historyIndex] || '';
          }
          return;
        }

        // Down arrow: Next command
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (historyIndex > 0) {
            historyIndex--;
            input.value = commandHistory[historyIndex] || '';
          } else {
            historyIndex = -1;
            input.value = '';
          }
          return;
        }
      }
    });

    // Modify runCommand to save history
    const originalRunCommand = runCommand;
    runCommand = async function() {
      const cmd = document.getElementById('command-input').value.trim();
      if (cmd) {
        saveToHistory(cmd);
        historyIndex = -1;
      }
      return originalRunCommand();
    };

    async function refreshAll() { await Promise.all([refreshHealth(), refreshVersion(), refreshServices(), refreshAgents(), refreshLocks(), refreshChannels(), refreshWebhooks(), refreshActivity(), refreshConfig()]); }
    refreshAll();
    setInterval(refreshAll, 5000);
  </script>
</body>
</html>
